<p style="color: green"><%= notice %></p>

<% content_for :title, @project.title %>

<h1><%= @project.title %></h1>

<p><strong>Author:</strong> <%= @project.author.name || "Unknown Author" %></p>
<p><strong>Description:</strong> <%= @project.description %></p>
<p><strong>Roles Available:</strong> <%= @project.role_cnt %></p>
<p><strong>Status:</strong> <%= @project.status.capitalize %></p>
<p><strong>Project Owner:</strong> <%= @project.author.email if @project.author %></p>

<hr>

<% if user_signed_in? %>
<%# --- Project Owner View --- %>
<% if current_user == @project.author %>
  <% if @project.open? %>
    <%= button_to "Close Listing", close_project_path(@project),
                  method: :patch,
                  class: "btn btn-warning" %>
  <% else %>
    <%= button_to "Reopen Listing", reopen_project_path(@project),
                  method: :patch,
                  class: "btn btn-success" %>
  <% end %>

  <p>
    <%= link_to "Edit", edit_project_path(@project), class: "btn btn-secondary" %> |
    <%= button_to "Delete this project", @project, method: :delete, data: { turbo_confirm: "Are you sure?" }, 
    class: "btn btn-danger" %>
  </p>

  <hr>

    <%# --- Pending Membership Requests --- %>
    <h3>Pending Applications</h3>
    <% pending_memberships = @project.memberships.where(status: "pending").includes(:user) %>

    <% if pending_memberships.any? %>
      <% pending_memberships.each do |membership| %>
        <div style="margin-bottom: 10px;">
          <strong><%= membership.user.name || membership.user.email %></strong>
          <%= button_to "Approve",
              project_membership_path(@project, membership),
              method: :patch,
              params: { status: "approved" },
              class: "btn btn-success btn-sm" %>
          <%= button_to "Reject",
              project_membership_path(@project, membership),
              method: :patch,
              params: { status: "rejected" },
              class: "btn btn-danger btn-sm" %>
        </div>
      <% end %>
    <% else %>
      <p>No pending applications.</p>
    <% end %>

  <%# --- Non-Owner (Applicant) View --- %>
  <% else %>
    <% if @project.open? %>
      <% existing_membership = @project.memberships.find_by(user: current_user) %>

      <% if existing_membership.nil? %>
        <%= button_to "Apply", project_memberships_path(@project),
            method: :post,
            class: "btn btn-primary",
            data: { turbo_confirm: "Apply to this project?" } %>

      <% elsif existing_membership.pending? %>
        <%= button_to "Withdraw Application",
            project_membership_path(@project, existing_membership),
            method: :delete,
            class: "btn btn-warning",
            data: { turbo_confirm: "Withdraw your application?" } %>
        <button class="btn btn-secondary" disabled>Application Pending</button>

      <% elsif existing_membership.approved? %>
        <%= button_to "Leave Project",
            project_membership_path(@project, existing_membership),
            method: :delete,
            class: "btn btn-danger",
            data: { turbo_confirm: "Leave this project?" } %>

      <% elsif existing_membership.rejected? %>
        <button class="btn btn-danger" disabled>Rejected</button>
      <% end %>

    <% else %>
      <p><em>This project is closed for new collaborators.</em></p>
    <% end %>
  <% end %>

<% else %>
  <p><%= link_to "Log in", new_user_session_path %> to apply or create your own projects.</p>
<% end %>

<hr>
<%= link_to "Back to Projects", projects_path, class: "btn btn-outline-primary" %>
